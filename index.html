<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ê°€ì„¼í„° ì›”ê°„ ì¼ì • (Firebase ìë™ ë™ê¸°í™”)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #e8f1ec;
            padding: 5px;
            min-height: 100vh;
        }

        /* ===== PIN ì…ë ¥ í™”ë©´ ìŠ¤íƒ€ì¼ ===== */
        #pinScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #e8f1ec;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #pinScreen.hidden {
            display: none;
        }

        .pin-container {
            background: white;
            border-radius: 16px;
            padding: 35px 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            max-width: 340px;
            width: 90%;
        }

        .pin-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .pin-subtitle {
            font-size: 13px;
            color: #999;
            margin-bottom: 30px;
            font-weight: 400;
        }

        .pin-dots {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
        }

        .pin-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #d4e8dd;
            transition: all 0.3s;
        }

        .pin-dot.filled {
            background: #5db88f;
            transform: scale(1.1);
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .pin-key {
            background: #e8f5f0;
            border: 1.5px solid #c5e3d8;
            border-radius: 10px;
            padding: 20px;
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            min-height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pin-key:hover {
            background: #d4e8dd;
            transform: scale(1.02);
            border-color: #a8d5c3;
        }

        .pin-key:active {
            transform: scale(0.95);
        }

        .pin-key.wide {
            grid-column: span 3;
            background: #5db88f;
            color: white;
            border-color: #5db88f;
            font-size: 18px;
            font-weight: 600;
        }

        .pin-key.wide:hover {
            background: #4da57d;
            border-color: #4da57d;
        }

        .pin-key.pin-back {
            background: white;
            color: #5db88f;
            border-color: #c5e3d8;
            font-size: 28px;
            font-weight: 400;
        }

        .pin-key.pin-back:hover {
            background: #f5f5f5;
            color: #4da57d;
            border-color: #a8d5c3;
        }

        .pin-key.pin-check {
            background: white;
            color: #5db88f;
            border-color: #c5e3d8;
            font-size: 32px;
            font-weight: 400;
        }

        .pin-key.pin-check:hover {
            background: #f5f5f5;
            color: #4da57d;
            border-color: #a8d5c3;
        }

        .pin-error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 10px;
            min-height: 20px;
        }

        .pin-attempts {
            color: #999;
            font-size: 11px;
            margin-top: 5px;
        }
        /* ===== PIN ìŠ¤íƒ€ì¼ ë ===== */

        .calendar-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: #bcddca;
        }

        .nav-btn {
            background: white;
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }

        .current-month {
            font-size: 13px;
            font-weight: 700;
            color: #333;
        }

        .button-container {
            display: flex;
            gap: 4px;
            padding: 5px;
            flex-wrap: wrap;
            background: #bcddca;
        }

        .top-btn {
            background: #4a9d6f;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 9px;
            transition: all 0.3s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .top-btn:hover {
            background: #3d8660;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #bcddca;
            padding: 3px;
            gap: 2px;
        }

        .weekday {
            text-align: center;
            font-weight: 600;
            color: #333;
            padding: 4px 2px;
            font-size: 9px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            padding: 3px;
            background: #e8f1ec;
        }

        .calendar-day {
            min-height: 50px;
            background: white;
            border-radius: 4px;
            padding: 3px;
            position: relative;
        }

        .calendar-day.drag-over {
            background: #f0f8f4;
            border: 2px dashed #4a9d6f;
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.today {
            background: #fff5f5;
            box-shadow: 0 0 0 2px #ff8fab;
        }

        .calendar-day.weekend {
            background: #f8f8f8;
        }

        .day-number {
            font-weight: 600;
            font-size: 9px;
            color: #333;
            margin-bottom: 2px;
        }

        .event-item {
            font-size: 7px;
            padding: 1px 3px;
            margin-bottom: 1px;
            border-radius: 2px;
            color: #333;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: move;
            transition: all 0.2s;
        }

        .event-item:hover {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .event-item.dragging {
            opacity: 0.5;
        }

        .event-bar {
            font-size: 7px;
            padding: 1px 3px;
            margin-bottom: 1px;
            border-radius: 2px;
            color: #333;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: move;
            transition: all 0.2s;
        }

        .event-bar:hover {
            opacity: 0.8;
        }

        .event-bar.dragging {
            opacity: 0.5;
        }

        /* ì¼ì • ìƒ‰ìƒ */
        .event-ì²­êµ¬ { background: #faccec; }
        .event-ë³¸ì¸ë¶€ë‹´ê¸ˆ { background: #cee1ff; }
        .event-ìš°í¸ë°œì†¡ { background: #87b3ef; }
        .event-ì–´ë¥´ì‹ ìƒë‹´ { background: #bcddca; }
        .event-ê¸‰ì—¬ëŒ€ì¥ { background: #b4e7ce; }
        .event-ìƒì‹¤ì‹ ê³  { background: #a8d8ea; }
        .event-ìš”ì–‘ì¼ì • { background: #ffe4b5; }
        .event-ì œê³µê¸°ë¡ì§€ { background: #a8d8ea; }
        .event-ëª…ì„¸ì„œ { background: #d4b5f6; }
        .event-custom { background: #ffd4e0; }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 12px;
            max-width: 280px;
            width: 90%;
        }

        .modal-header {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group {
            margin-bottom: 8px;
        }

        .form-label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            color: #333;
            font-size: 9px;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #bcddca;
            border-radius: 4px;
            font-size: 9px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 40px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 5px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 12px;
            height: 12px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-weight: 500;
            cursor: pointer;
            font-size: 9px;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.05);
        }

        .modal-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .modal-btn {
            flex: 1;
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 9px;
        }

        .modal-btn-primary {
            background: #4a9d6f;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #3d8660;
        }

        .modal-btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn-secondary:hover {
            background: #d0d0d0;
        }

        .modal-btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .modal-btn-danger:hover {
            background: #ff5252;
        }

        /* ì—°ì† ì¼ì • ìŠ¤íƒ€ì¼ */
        .multi-day-start {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .multi-day-middle {
            border-radius: 0;
        }

        .multi-day-end {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .helper-text {
            font-size: 7px;
            color: #666;
            margin-top: 2px;
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            body {
                padding: 2px;
            }
            
            .calendar-container {
                max-width: 100%;
                border-radius: 0;
            }
            
            .calendar-header {
                padding: 10px 8px;
            }
            
            .current-month {
                font-size: 14px;
            }
            
            .nav-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .button-container {
                padding: 8px 5px;
            }
            
            .top-btn {
                padding: 5px 10px;
                font-size: 11px;
            }
            
            .weekday {
                padding: 6px 2px;
                font-size: 11px;
            }
            
            .calendar-day {
                min-height: 70px;
                padding: 4px;
            }
            
            .day-number {
                font-size: 11px;
                margin-bottom: 3px;
            }
            
            .event-item, .event-bar {
                font-size: 9px;
                padding: 2px 4px;
                margin-bottom: 2px;
            }
            
            /* ëª¨ë°”ì¼ ëª¨ë‹¬ì°½ */
            .modal-content {
                max-width: 320px;
                padding: 15px;
            }
            
            .modal-header {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .form-group {
                margin-bottom: 10px;
            }
            
            .form-label {
                font-size: 11px;
                margin-bottom: 4px;
            }
            
            .form-input, .form-textarea {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            .form-textarea {
                min-height: 50px;
            }
            
            .checkbox-group label {
                font-size: 11px;
            }
            
            .checkbox-group input[type="checkbox"] {
                width: 14px;
                height: 14px;
            }
            
            .color-palette {
                gap: 6px;
            }
            
            .color-option {
                border-radius: 5px;
            }
            
            .helper-text {
                font-size: 9px;
            }
            
            .modal-btn {
                padding: 8px 10px;
                font-size: 11px;
            }
            
            .modal-actions {
                gap: 6px;
                margin-top: 10px;
            }

            /* ëª¨ë°”ì¼ PIN í™”ë©´ */
            .pin-container {
                padding: 30px 20px;
            }

            .pin-title {
                font-size: 17px;
            }

            .pin-subtitle {
                font-size: 12px;
            }

            .pin-key {
                padding: 18px;
                font-size: 22px;
                min-height: 60px;
            }

            .pin-keypad {
                gap: 8px;
            }

            .pin-key.pin-back {
                font-size: 26px;
            }

            .pin-key.pin-check {
                font-size: 30px;
            }
        }
        
        /* íƒœë¸”ë¦¿ í¬ê¸° */
        @media (min-width: 769px) and (max-width: 1024px) {
            .calendar-container {
                max-width: 700px;
            }
            
            /* íƒœë¸”ë¦¿ ëª¨ë‹¬ì°½ - ë°ìŠ¤í¬í†±ê³¼ ë™ì¼í•˜ê²Œ ì‘ê²Œ ìœ ì§€ */
            .modal-content {
                max-width: 280px;
            }
        }
    </style>
</head>
<body>
    <!-- PIN ì…ë ¥ í™”ë©´ -->
    <div id="pinScreen">
        <div class="pin-container">
            <div class="pin-title">ğŸ” ì¬ê°€ì„¼í„° ìº˜ë¦°ë”</div>
            <div class="pin-subtitle">PIN ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
            
            <div class="pin-dots">
                <div class="pin-dot" id="dot1"></div>
                <div class="pin-dot" id="dot2"></div>
                <div class="pin-dot" id="dot3"></div>
                <div class="pin-dot" id="dot4"></div>
            </div>

            <div class="pin-keypad">
                <button class="pin-key" onclick="window.pinInput(1)">1</button>
                <button class="pin-key" onclick="window.pinInput(2)">2</button>
                <button class="pin-key" onclick="window.pinInput(3)">3</button>
                <button class="pin-key" onclick="window.pinInput(4)">4</button>
                <button class="pin-key" onclick="window.pinInput(5)">5</button>
                <button class="pin-key" onclick="window.pinInput(6)">6</button>
                <button class="pin-key" onclick="window.pinInput(7)">7</button>
                <button class="pin-key" onclick="window.pinInput(8)">8</button>
                <button class="pin-key" onclick="window.pinInput(9)">9</button>
                <button class="pin-key pin-back" onclick="window.pinClear()">â†</button>
                <button class="pin-key" onclick="window.pinInput(0)">0</button>
                <button class="pin-key pin-check" onclick="window.pinSubmit()">âœ“</button>
            </div>

            <div class="pin-error" id="pinError"></div>
            <div class="pin-attempts" id="pinAttempts">ë‚¨ì€ ì‹œë„: 5íšŒ</div>
        </div>
    </div>

    <!-- ìº˜ë¦°ë” (PIN ì¸ì¦ í›„ í‘œì‹œ) -->
    <div class="calendar-container">
        <div class="calendar-header">
            <button class="nav-btn" onclick="window.prevMonth()">â—€ ì´ì „ ë‹¬</button>
            <div class="current-month" id="currentMonth"></div>
            <button class="nav-btn" onclick="window.nextMonth()">ë‹¤ìŒ ë‹¬ â–¶</button>
        </div>
        
        <div class="button-container">
            <button class="top-btn" onclick="window.openAddEventModal()">ì¼ì • ì¶”ê°€</button>
            <button class="top-btn" style="background: #e74c3c;" onclick="window.showAllEvents()">ğŸ” ëª¨ë“  ì¼ì • ë³´ê¸°</button>

        </div>

        <div class="weekdays">
            <div class="weekday">ì¼</div>
            <div class="weekday">ì›”</div>
            <div class="weekday">í™”</div>
            <div class="weekday">ìˆ˜</div>
            <div class="weekday">ëª©</div>
            <div class="weekday">ê¸ˆ</div>
            <div class="weekday">í† </div>
        </div>

        <div class="calendar-grid" id="calendar"></div>
    </div>

    <!-- ì¼ì • ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="eventModal" onclick="if(event.target.id==='eventModal') window.closeModal()">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">ì¼ì • ì¶”ê°€</div>
            
            <div class="form-group">
                <label class="form-label">ì¼ì • ì œëª©</label>
                <input type="text" class="form-input" id="eventTitle">
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="isMultiDayEvent" onchange="window.toggleDateRange()">
                    <label for="isMultiDayEvent">ì—°ì† ì¼ì • (ì—¬ëŸ¬ ë‚ )</label>
                </div>
                <div class="helper-text">ì²´í¬í•˜ë©´ ì‹œì‘ì¼~ì¢…ë£Œì¼ ì„¤ì • ê°€ëŠ¥</div>
            </div>
            
            <div class="form-group" id="excludeWeekendsGroup" style="display: none;">
                <div class="checkbox-group">
                    <input type="checkbox" id="excludeWeekends" checked>
                    <label for="excludeWeekends">ì£¼ë§ ì œì™¸ (í‰ì¼ë§Œ)</label>
                </div>
                <div class="helper-text">ì—°ì† ì¼ì •ì´ í‰ì¼ì—ë§Œ í‘œì‹œë©ë‹ˆë‹¤</div>
            </div>

            <div class="form-group">
                <label class="form-label">ë‚ ì§œ</label>
                <div id="dateRangeContainer">
                    <input type="date" class="form-input" id="eventDateSingle">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ìƒ‰ìƒ</label>
                <div class="color-palette" id="colorPalette">
                    <!-- ë¹¨ê°• ê³„ì—´: ì˜¥ìŒ -> ì§„í•¨ -->
                    <div class="color-option" id="color-ffcfd2" style="background: #ffcfd2;" onclick="selectColorDirect('#ffcfd2')"></div>
                    <div class="color-option selected" id="color-ffd4e0" style="background: #ffd4e0;" onclick="selectColorDirect('#ffd4e0')"></div>
                    <div class="color-option" id="color-f28482" style="background: #f28482;" onclick="selectColorDirect('#f28482')"></div>
                    <div class="color-option" id="color-ff5a5f" style="background: #ff5a5f;" onclick="selectColorDirect('#ff5a5f')"></div>
                    
                    <!-- ì£¼í™©/ë…¸ë‘ ê³„ì—´: ì˜¥ìŒ -> ì§„í•¨ -->
                    <div class="color-option" id="color-fdffb6" style="background: #fdffb6;" onclick="selectColorDirect('#fdffb6')"></div>
                    <div class="color-option" id="color-fbf8cc" style="background: #fbf8cc;" onclick="selectColorDirect('#fbf8cc')"></div>
                    <div class="color-option" id="color-ffe4b5" style="background: #ffe4b5;" onclick="selectColorDirect('#ffe4b5')"></div>
                    
                    <!-- ì´ˆë¡ ê³„ì—´: ì˜¥ìŒ -> ì§„í•¨ -->
                    <div class="color-option" id="color-eaf4f4" style="background: #eaf4f4;" onclick="selectColorDirect('#eaf4f4')"></div>
                    <div class="color-option" id="color-cce3de" style="background: #cce3de;" onclick="selectColorDirect('#cce3de')"></div>
                    <div class="color-option" id="color-b4e7ce" style="background: #b4e7ce;" onclick="selectColorDirect('#b4e7ce')"></div>
                    <div class="color-option" id="color-bcddca" style="background: #bcddca;" onclick="selectColorDirect('#bcddca')"></div>
                    <div class="color-option" id="color-6b9080" style="background: #6b9080;" onclick="selectColorDirect('#6b9080')"></div>
                    
                    <!-- íŒŒë‘ ê³„ì—´: ì˜¥ìŒ -> ì§„í•¨ -->
                    <div class="color-option" id="color-cee1ff" style="background: #cee1ff;" onclick="selectColorDirect('#cee1ff')"></div>
                    <div class="color-option" id="color-a8d8ea" style="background: #a8d8ea;" onclick="selectColorDirect('#a8d8ea')"></div>
                    <div class="color-option" id="color-87b3ef" style="background: #87b3ef;" onclick="selectColorDirect('#87b3ef')"></div>
                    
                    <!-- ë³´ë¼ ê³„ì—´: ì˜¥ìŒ -> ì§„í•¨ -->
                    <div class="color-option" id="color-faccec" style="background: #faccec;" onclick="selectColorDirect('#faccec')"></div>
                    <div class="color-option" id="color-d4b5f6" style="background: #d4b5f6;" onclick="selectColorDirect('#d4b5f6')"></div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
                <textarea class="form-textarea" id="eventMemo"></textarea>
            </div>

            <div class="modal-actions">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="window.closeModal()">ì·¨ì†Œ</button>
                <button type="button" class="modal-btn modal-btn-danger" id="deleteBtn" onclick="event.stopPropagation(); window.deleteEvent();" style="display: none;">ì¦‰ì‹œ ì‚­ì œ</button>
                <button type="button" class="modal-btn modal-btn-primary" onclick="window.saveEvent()">ì €ì¥</button>
            </div>
        </div>
    </div>

    

    <!-- ëª¨ë“  ì¼ì • ë³´ê¸° ëª¨ë‹¬ -->
    <div class="modal" id="allEventsModal" onclick="if(event.target.id==='allEventsModal') window.closeAllEventsModal()">
        <div class="modal-content" style="max-width: 400px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">ğŸ“‹ ì €ì¥ëœ ëª¨ë“  ì¼ì •</div>
            <div id="allEventsList" style="font-size: 11px;"></div>
            <div class="modal-actions">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="window.closeAllEventsModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (CDN) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // ===== PIN ì¸ì¦ ì‹œìŠ¤í…œ =====
        const CORRECT_PIN = "1234"; // ì—¬ê¸°ì„œ PIN ë²ˆí˜¸ ë³€ê²½ ê°€ëŠ¥
        let pinAttempts = 5;
        let enteredPin = "";

        // PIN ìˆ«ì ì…ë ¥
        window.pinInput = function(num) {
            if (enteredPin.length < 4) {
                enteredPin += num;
                updatePinDots();
                
                // 4ìë¦¬ ì…ë ¥ë˜ë©´ ìë™ í™•ì¸
                if (enteredPin.length === 4) {
                    setTimeout(() => window.pinSubmit(), 300);
                }
            }
        };

        // PIN ì§€ìš°ê¸°
        window.pinClear = function() {
            enteredPin = "";
            updatePinDots();
            document.getElementById('pinError').textContent = "";
        };

        // PIN ì  ì—…ë°ì´íŠ¸
        function updatePinDots() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`dot${i}`);
                if (i <= enteredPin.length) {
                    dot.classList.add('filled');
                } else {
                    dot.classList.remove('filled');
                }
            }
        }

        // PIN í™•ì¸
        window.pinSubmit = function() {
            if (enteredPin.length !== 4) {
                document.getElementById('pinError').textContent = "4ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”";
                return;
            }

            if (enteredPin === CORRECT_PIN) {
                // PIN ì •í™• â†’ Firebase ìµëª… ë¡œê·¸ì¸ â†’ ìº˜ë¦°ë” í‘œì‹œ
                document.getElementById('pinError').textContent = "âœ“ ì¸ì¦ ì„±ê³µ!";
                document.getElementById('pinError').style.color = "#4a9d6f";
                
                setTimeout(() => {
                    initFirebaseAuth();
                }, 500);
            } else {
                // PIN í‹€ë¦¼
                pinAttempts--;
                
                if (pinAttempts > 0) {
                    document.getElementById('pinError').textContent = `âŒ ì˜ëª»ëœ PIN ë²ˆí˜¸ì…ë‹ˆë‹¤`;
                    document.getElementById('pinAttempts').textContent = `ë‚¨ì€ ì‹œë„: ${pinAttempts}íšŒ`;
                    enteredPin = "";
                    updatePinDots();
                } else {
                    document.getElementById('pinError').textContent = "âŒ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.";
                    document.getElementById('pinAttempts').textContent = "";
                    // í‚¤íŒ¨ë“œ ë¹„í™œì„±í™”
                    document.querySelectorAll('.pin-key').forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    });
                }
            }
        };

        // í‚¤ë³´ë“œ ì…ë ¥ ì§€ì›
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('pinScreen').classList.contains('hidden')) return;
            
            if (e.key >= '0' && e.key <= '9') {
                window.pinInput(parseInt(e.key));
            } else if (e.key === 'Backspace') {
                window.pinClear();
            } else if (e.key === 'Enter') {
                window.pinSubmit();
            }
        });

        // Firebase ìµëª… ì¸ì¦ ì´ˆê¸°í™”
        function initFirebaseAuth() {
            console.log('ğŸ” Firebase ìµëª… ì¸ì¦ ì‹œì‘...');
            
            // Firebase ì„¤ì •
            const firebaseConfig = {
                apiKey: "AIzaSyDq0COBu1ykozOe56wQWzfJRz5moULbrPE",
                authDomain: "home-care-center-calendar.firebaseapp.com",
                databaseURL: "https://home-care-center-calendar-default-rtdb.firebaseio.com",
                projectId: "home-care-center-calendar",
                storageBucket: "home-care-center-calendar.firebasestorage.app",
                messagingSenderId: "609266329861",
                appId: "1:609266329861:web:894513b00c671690baaf6c"
            };

            // Firebase ì´ˆê¸°í™”
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const database = firebase.database();

            // ìµëª… ë¡œê·¸ì¸
            auth.signInAnonymously()
                .then(() => {
                    console.log('âœ… Firebase ìµëª… ë¡œê·¸ì¸ ì„±ê³µ!');
                    
                    // PIN í™”ë©´ ìˆ¨ê¸°ê¸°
                    document.getElementById('pinScreen').classList.add('hidden');
                    
                    // ìº˜ë¦°ë” ì´ˆê¸°í™”
                    initCalendar(database);
                })
                .catch((error) => {
                    console.error('âŒ Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                    document.getElementById('pinError').textContent = "ì¸ì¦ ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
                    document.getElementById('pinError').style.color = "#e74c3c";
                });
        }

        // ===== ìº˜ë¦°ë” ì‹œìŠ¤í…œ (ê¸°ì¡´ ì½”ë“œ) =====
        function initCalendar(database) {
            window.database = database; // ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥

            // ìƒ‰ìƒ ì„ íƒ í•¨ìˆ˜ (ì „ì—­)
            window.selectColorDirect = function(color) {
                window.selectedColor = color;
                
                // ëª¨ë“  selected ì œê±°
                var options = document.getElementsByClassName('color-option');
                for (var i = 0; i < options.length; i++) {
                    options[i].classList.remove('selected');
                }
                
                // ì„ íƒëœ ìƒ‰ìƒì— selected ì¶”ê°€
                var selectedOption = document.getElementById('color-' + color.substring(1));
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            };
            
            // ì „ì—­ ë³€ìˆ˜
            window.currentDate = new Date();
            window.customEvents = {}; // ê°ì²´ë¡œ ë³€ê²½ (ID ê¸°ë°˜)
            window.deletedRecurringEvents = [];
            window.isDataLoaded = false; // ë°ì´í„° ë¡œë“œ ì™„ë£Œ í”Œë˜ê·¸
            window.isSaving = false; // ì €ì¥ ì¤‘ í”Œë˜ê·¸ (ì‹¤ì‹œê°„ ë™ê¸°í™” ì¶©ëŒ ë°©ì§€) // ì‚­ì œëœ ì •ê¸° ì¼ì • ID ëª©ë¡
            window.selectedColor = '#ffd4e0';
            window.editingEvent = null;
            window.draggedEvent = null;

            // Firebase ì‹¤ì‹œê°„ ë™ê¸°í™” (ë¦¬ìŠ¤ë„ˆ ë“±ë¡)
            window.loadCustomEvents = function() {
                // ì»¤ìŠ¤í…€ ì¼ì • ì‹¤ì‹œê°„ ë™ê¸°í™”
                database.ref('calendar_data/customEvents').on('value', (snapshot) => {
                    // ì €ì¥ ì¤‘ì¼ ë•ŒëŠ” ì—…ë°ì´íŠ¸ ë¬´ì‹œ (ì‚­ì œ/ìˆ˜ì • ì¶©ëŒ ë°©ì§€)
                    if (window.isSaving) {
                        return;
                    }
                    
                    const data = snapshot.val();
                    
                    if (data) {
                        // ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                        window.customEvents = data;
                        console.log('ğŸ“¥ Firebaseì—ì„œ ì»¤ìŠ¤í…€ ì¼ì • ë¡œë“œ (ê°ì²´):', Object.keys(data).length, 'ê°œ');
                    } else {
                        window.customEvents = {};
                        console.log('ğŸ“¥ Firebaseì— ì €ì¥ëœ ì»¤ìŠ¤í…€ ì¼ì • ì—†ìŒ');
                    }
                    
                    window.isDataLoaded = true;
                    window.renderCalendar(); // ë°ì´í„° ë³€ê²½ ì‹œ ìë™ ë Œë”ë§
                });

                // ì‚­ì œëœ ì •ê¸° ì¼ì • ì‹¤ì‹œê°„ ë™ê¸°í™”
                database.ref('calendar_data/deletedRecurringEvents').on('value', (snapshot) => {
                    // ì €ì¥ ì¤‘ì¼ ë•ŒëŠ” ì—…ë°ì´íŠ¸ ë¬´ì‹œ
                    if (window.isSaving) {
                        return;
                    }
                    
                    const data = snapshot.val();
                    
                    if (data && Array.isArray(data)) {
                        window.deletedRecurringEvents = data;
                        console.log('ğŸ“¥ Firebaseì—ì„œ ì‚­ì œ ëª©ë¡ ë¡œë“œ:', data.length, 'ê°œ');
                    } else {
                        window.deletedRecurringEvents = [];
                        console.log('ğŸ“¥ Firebaseì— ì‚­ì œ ëª©ë¡ ì—†ìŒ');
                    }
                    
                    window.renderCalendar();
                });
            };

            // ì •ê¸° ì¼ì • ë°ì´í„° (2025ë…„ 11ì›” ë³¸ì¸ë¶€ë‹´ê¸ˆë§Œ ì œì™¸)
            const recurringSchedule = [
                // 1~2ì¼: ì²­êµ¬ (2ì¼ë§Œ)
                { title: 'ì²­êµ¬', day: 2, cssClass: 'event-ì²­êµ¬' },
                // 3~6ì¼: ë³¸ì¸ë¶€ë‹´ê¸ˆ ì œì™¸ (11ì›”ë§Œ)
                // 7~9ì¼: ìš°í¸ë°œì†¡
                { title: 'ìš°í¸ë°œì†¡', day: 7, cssClass: 'event-ìš°í¸ë°œì†¡' },
                { title: 'ìš°í¸ë°œì†¡', day: 8, cssClass: 'event-ìš°í¸ë°œì†¡' },
                { title: 'ìš°í¸ë°œì†¡', day: 9, cssClass: 'event-ìš°í¸ë°œì†¡' },
                // 10ì¼: ì–´ë¥´ì‹ ìƒë‹´
                { title: 'ì–´ë¥´ì‹ ìƒë‹´', day: 10, cssClass: 'event-ì–´ë¥´ì‹ ìƒë‹´' },
                // 11~12ì¼: ê¸‰ì—¬ëŒ€ì¥
                { title: 'ê¸‰ì—¬ëŒ€ì¥', day: 11, cssClass: 'event-ê¸‰ì—¬ëŒ€ì¥' },
                { title: 'ê¸‰ì—¬ëŒ€ì¥', day: 12, cssClass: 'event-ê¸‰ì—¬ëŒ€ì¥' },
                // 13ì¼: ìƒì‹¤ì‹ ê³ 
                { title: 'ìƒì‹¤ì‹ ê³ ', day: 13, cssClass: 'event-ìƒì‹¤ì‹ ê³ ' },
                // 14~19ì¼: ìš”ì–‘ì¼ì •
                { title: 'ìš”ì–‘ì¼ì •', day: 14, cssClass: 'event-ìš”ì–‘ì¼ì •' },
                { title: 'ìš”ì–‘ì¼ì •', day: 15, cssClass: 'event-ìš”ì–‘ì¼ì •' },
                { title: 'ìš”ì–‘ì¼ì •', day: 16, cssClass: 'event-ìš”ì–‘ì¼ì •' },
                { title: 'ìš”ì–‘ì¼ì •', day: 17, cssClass: 'event-ìš”ì–‘ì¼ì •' },
                { title: 'ìš”ì–‘ì¼ì •', day: 18, cssClass: 'event-ìš”ì–‘ì¼ì •' },
                { title: 'ìš”ì–‘ì¼ì •', day: 19, cssClass: 'event-ìš”ì–‘ì¼ì •' },
                // 20~23ì¼: ì œê³µê¸°ë¡ì§€
                { title: 'ì œê³µê¸°ë¡ì§€', day: 20, cssClass: 'event-ì œê³µê¸°ë¡ì§€' },
                { title: 'ì œê³µê¸°ë¡ì§€', day: 21, cssClass: 'event-ì œê³µê¸°ë¡ì§€' },
                { title: 'ì œê³µê¸°ë¡ì§€', day: 22, cssClass: 'event-ì œê³µê¸°ë¡ì§€' },
                { title: 'ì œê³µê¸°ë¡ì§€', day: 23, cssClass: 'event-ì œê³µê¸°ë¡ì§€' },
                // 24~26ì¼: ëª…ì„¸ì„œ
                { title: 'ëª…ì„¸ì„œ', day: 24, cssClass: 'event-ëª…ì„¸ì„œ' },
                { title: 'ëª…ì„¸ì„œ', day: 25, cssClass: 'event-ëª…ì„¸ì„œ' },
                { title: 'ëª…ì„¸ì„œ', day: 26, cssClass: 'event-ëª…ì„¸ì„œ' }
            ];

            function getRecurringEvents(year, month) {
                // 2025ë…„ 11ì›”ì¸ì§€ í™•ì¸
                const isNov2025 = (year === 2025 && month === 10); // monthëŠ” 0-based
                
                return recurringSchedule
                    .filter(event => {
                        // 2025ë…„ 11ì›”ì´ë©´ ë³¸ì¸ë¶€ë‹´ê¸ˆ ì œì™¸
                        if (isNov2025 && event.title === 'ë³¸ì¸ë¶€ë‹´ê¸ˆ') {
                            return false;
                        }
                        return true;
                    })
                    .map(event => {
                        const id = `recurring_${year}_${month + 1}_${event.day}_${event.title}`;
                        return {
                            id: id,
                            title: event.title,
                            date: `${year}-${String(month + 1).padStart(2, '0')}-${String(event.day).padStart(2, '0')}`,
                            cssClass: event.cssClass,
                            isRecurring: true
                        };
                    })
                    .filter(event => !window.deletedRecurringEvents.includes(event.id)); // ì‚­ì œëœ ì¼ì • ì œì™¸
            }

            // ìº˜ë¦°ë” ë Œë”ë§ í•¨ìˆ˜
            window.renderCalendar = function() {
                if (!window.isDataLoaded) {
                    console.log('â³ ë°ì´í„° ë¡œë“œ ì¤‘... ë Œë”ë§ ëŒ€ê¸°');
                    return;
                }
                
                const year = window.currentDate.getFullYear();
                const month = window.currentDate.getMonth();
                
                // ì›” ì œëª© ì—…ë°ì´íŠ¸
                document.getElementById('currentMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;
                
                // ë‹¬ë ¥ ê·¸ë¦¬ë“œ ìƒì„±
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                
                let html = '';
                
                // ì´ì „ ë‹¬ ë¹ˆ ì¹¸
                const prevMonthDays = new Date(year, month, 0).getDate();
                for (let i = firstDay - 1; i >= 0; i--) {
                    const day = prevMonthDays - i;
                    const isWeekend = (firstDay - 1 - i) % 7 === 0 || (firstDay - 1 - i) % 7 === 6;
                    html += `<div class="calendar-day other-month ${isWeekend ? 'weekend' : ''}">
                        <div class="day-number">${day}</div>
                    </div>`;
                }
                
                // í˜„ì¬ ë‹¬ ë‚ ì§œ
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayOfWeek = new Date(year, month, day).getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isToday = year === today.getFullYear() && 
                                  month === today.getMonth() && 
                                  day === today.getDate();
                    
                    // í•´ë‹¹ ë‚ ì§œì˜ ì¼ì • ìˆ˜ì§‘ (ì •ê¸° ì¼ì • + ì»¤ìŠ¤í…€ ì¼ì •)
                    let events = [];
                    
                    // ì •ê¸° ì¼ì • ì¶”ê°€
                    const recurringEvents = getRecurringEvents(year, month);
                    events = events.concat(recurringEvents.filter(e => e.date === dateStr));
                    
                    // ì»¤ìŠ¤í…€ ì¼ì • ì¶”ê°€ (ê°ì²´ ìˆœíšŒ)
                    for (const [id, event] of Object.entries(window.customEvents)) {
                        if (event.date === dateStr || 
                            (event.startDate && event.endDate && dateStr >= event.startDate && dateStr <= event.endDate)) {
                            
                            // ì£¼ë§ ì œì™¸ ì˜µì…˜ì´ ìˆê³ , ì˜¤ëŠ˜ì´ ì£¼ë§ì´ë©´ ê±´ë„ˆë›°ê¸°
                            if (event.excludeWeekends && isWeekend) {
                                continue;
                            }
                            
                            events.push({
                                ...event,
                                id: id
                            });
                        }
                    }
                    
                    // ì¼ì • HTML ìƒì„±
                    let eventsHtml = '';
                    events.forEach(event => {
                        const eventStyle = event.color ? `background: ${event.color};` : '';
                        const eventClass = event.color ? '' : (event.cssClass || 'event-custom');
                        
                        // ì—°ì† ì¼ì • ìŠ¤íƒ€ì¼ ì²˜ë¦¬
                        let multiDayClass = '';
                        if (event.startDate && event.endDate) {
                            if (dateStr === event.startDate) multiDayClass = 'multi-day-start';
                            else if (dateStr === event.endDate) multiDayClass = 'multi-day-end';
                            else multiDayClass = 'multi-day-middle';
                        }
                        
                        eventsHtml += `<div class="event-bar ${eventClass} ${multiDayClass}" 
                            style="${eventStyle}" 
                            draggable="true"
                            onclick="window.editEvent('${event.id}')"
                            ondragstart="window.handleDragStart(event, '${event.id}')"
                            ondragend="window.handleDragEnd(event)">
                            ${event.title}
                        </div>`;
                    });
                    
                    html += `<div class="calendar-day ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}"
                        ondrop="window.handleDrop(event, '${dateStr}')"
                        ondragover="window.handleDragOver(event)"
                        ondragleave="window.handleDragLeave(event)">
                        <div class="day-number">${day}</div>
                        ${eventsHtml}
                    </div>`;
                }
                
                // ë‹¤ìŒ ë‹¬ ë¹ˆ ì¹¸
                const totalCells = firstDay + daysInMonth;
                const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
                for (let day = 1; day <= remainingCells; day++) {
                    const isWeekend = (firstDay + daysInMonth + day - 1) % 7 === 0 || (firstDay + daysInMonth + day - 1) % 7 === 6;
                    html += `<div class="calendar-day other-month ${isWeekend ? 'weekend' : ''}">
                        <div class="day-number">${day}</div>
                    </div>`;
                }
                
                document.getElementById('calendar').innerHTML = html;
            };

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            window.handleDragStart = function(e, eventId) {
                window.draggedEvent = eventId;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            };

            window.handleDragEnd = function(e) {
                e.target.classList.remove('dragging');
            };

            window.handleDragOver = function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                e.currentTarget.classList.add('drag-over');
            };

            window.handleDragLeave = function(e) {
                e.currentTarget.classList.remove('drag-over');
            };

            window.handleDrop = function(e, newDate) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                
                if (!window.draggedEvent) return;
                
                // ì •ê¸° ì¼ì •ì€ ì´ë™ ë¶ˆê°€
                if (window.draggedEvent.startsWith('recurring_')) {
                    alert('ì •ê¸° ì¼ì •ì€ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚­ì œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    window.draggedEvent = null;
                    return;
                }
                
                // ì»¤ìŠ¤í…€ ì¼ì •ë§Œ ì´ë™ ê°€ëŠ¥
                const event = window.customEvents[window.draggedEvent];
                if (event) {
                    window.isSaving = true; // ì €ì¥ í”Œë˜ê·¸ ì„¤ì •
                    
                    // ì—°ì† ì¼ì •ì˜ ê²½ìš°
                    if (event.startDate && event.endDate) {
                        const oldStart = new Date(event.startDate);
                        const oldEnd = new Date(event.endDate);
                        const duration = (oldEnd - oldStart) / (1000 * 60 * 60 * 24);
                        
                        const newStart = new Date(newDate);
                        const newEnd = new Date(newStart);
                        newEnd.setDate(newEnd.getDate() + duration);
                        
                        event.startDate = newDate;
                        event.endDate = newEnd.toISOString().split('T')[0];
                    } else {
                        event.date = newDate;
                    }
                    
                    // Firebase ì—…ë°ì´íŠ¸ (ê°ì²´ ì „ì²´ ì €ì¥)
                    database.ref('calendar_data/customEvents').set(window.customEvents)
                        .then(() => {
                            console.log('âœ… ì¼ì • ì´ë™ ì™„ë£Œ (Firebase)');
                            window.isSaving = false; // ì €ì¥ ì™„ë£Œ
                        })
                        .catch(error => {
                            console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
                            window.isSaving = false;
                        });
                }
                
                window.draggedEvent = null;
            };

            // ì¼ì • ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
            window.openAddEventModal = function() {
                window.editingEvent = null;
                document.getElementById('modalTitle').textContent = 'ì¼ì • ì¶”ê°€';
                document.getElementById('eventTitle').value = '';
                document.getElementById('eventDateSingle').value = '';
                document.getElementById('eventMemo').value = '';
                document.getElementById('isMultiDayEvent').checked = false;
                document.getElementById('excludeWeekends').checked = true;
                window.toggleDateRange();
                window.selectedColor = '#ffd4e0';
                
                // ìƒ‰ìƒ ì„ íƒ ì´ˆê¸°í™”
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                document.getElementById('color-ffd4e0').classList.add('selected');
                
                document.getElementById('deleteBtn').style.display = 'none';
                document.getElementById('eventModal').classList.add('active');
            };

            // ì¼ì • ìˆ˜ì •
            window.editEvent = function(eventId) {
                // ì •ê¸° ì¼ì • í´ë¦­ ì‹œ ì‚­ì œë§Œ í—ˆìš©
                if (eventId.startsWith('recurring_')) {
                    const recurringEvents = getRecurringEvents(
                        window.currentDate.getFullYear(), 
                        window.currentDate.getMonth()
                    );
                    const event = recurringEvents.find(e => e.id === eventId);
                    
                    if (event) {
                        const confirmed = window.confirm(`"${event.title}" ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì¼ì •ì€ ì •ê¸° ì¼ì •ì´ë¯€ë¡œ ì‚­ì œí•˜ë©´ ë‹¤ì‹œ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                        
                        if (confirmed) {
                            window.isSaving = true;
                            
                            // ì‚­ì œ ëª©ë¡ì— ì¶”ê°€
                            window.deletedRecurringEvents.push(eventId);
                            
                            // Firebase ì—…ë°ì´íŠ¸
                            database.ref('calendar_data/deletedRecurringEvents').set(window.deletedRecurringEvents)
                                .then(() => {
                                    console.log('âœ… ì •ê¸° ì¼ì • ì‚­ì œ ì™„ë£Œ (Firebase)');
                                    window.isSaving = false;
                                })
                                .catch(error => {
                                    console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
                                    window.isSaving = false;
                                });
                        }
                    }
                    return;
                }
                
                // ì»¤ìŠ¤í…€ ì¼ì • ìˆ˜ì •
                const event = window.customEvents[eventId];
                if (event) {
                    window.editingEvent = { id: eventId, ...event };
                    document.getElementById('modalTitle').textContent = 'ì¼ì • ìˆ˜ì •';
                    document.getElementById('eventTitle').value = event.title;
                    document.getElementById('eventMemo').value = event.memo || '';
                    
                    // ì—°ì† ì¼ì • ì—¬ë¶€
                    const isMultiDay = event.startDate && event.endDate;
                    document.getElementById('isMultiDayEvent').checked = isMultiDay;
                    
                    if (isMultiDay) {
                        document.getElementById('eventDateStart').value = event.startDate;
                        document.getElementById('eventDateEnd').value = event.endDate;
                        document.getElementById('excludeWeekends').checked = event.excludeWeekends || false;
                    } else {
                        document.getElementById('eventDateSingle').value = event.date;
                    }
                    
                    window.toggleDateRange();
                    
                    // ìƒ‰ìƒ ì„ íƒ
                    window.selectedColor = event.color || '#ffd4e0';
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    const colorId = 'color-' + window.selectedColor.substring(1);
                    const selectedOption = document.getElementById(colorId);
                    if (selectedOption) {
                        selectedOption.classList.add('selected');
                    }
                    
                    document.getElementById('deleteBtn').style.display = 'block';
                    document.getElementById('eventModal').classList.add('active');
                }
            };

            // ì—°ì† ì¼ì • í† ê¸€
            window.toggleDateRange = function() {
                const isMultiDay = document.getElementById('isMultiDayEvent').checked;
                const container = document.getElementById('dateRangeContainer');
                const excludeGroup = document.getElementById('excludeWeekendsGroup');
                
                if (isMultiDay) {
                    container.innerHTML = `
                        <input type="date" class="form-input" id="eventDateStart" style="margin-bottom: 5px;">
                        <input type="date" class="form-input" id="eventDateEnd">
                    `;
                    excludeGroup.style.display = 'block';
                } else {
                    container.innerHTML = `<input type="date" class="form-input" id="eventDateSingle">`;
                    excludeGroup.style.display = 'none';
                }
            };

            // ëª¨ë‹¬ ë‹«ê¸°
            window.closeModal = function() {
                document.getElementById('eventModal').classList.remove('active');
            };

            // ì¼ì • ì €ì¥
            window.saveEvent = function() {
                const title = document.getElementById('eventTitle').value.trim();
                const memo = document.getElementById('eventMemo').value.trim();
                const isMultiDay = document.getElementById('isMultiDayEvent').checked;
                
                if (!title) {
                    alert('ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
                    return;
                }
                
                let eventData = {
                    title: title,
                    memo: memo,
                    color: window.selectedColor
                };
                
                if (isMultiDay) {
                    const startDate = document.getElementById('eventDateStart').value;
                    const endDate = document.getElementById('eventDateEnd').value;
                    const excludeWeekends = document.getElementById('excludeWeekends').checked;
                    
                    if (!startDate || !endDate) {
                        alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•˜ì„¸ìš”');
                        return;
                    }
                    
                    if (startDate > endDate) {
                        alert('ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤');
                        return;
                    }
                    
                    eventData.startDate = startDate;
                    eventData.endDate = endDate;
                    eventData.excludeWeekends = excludeWeekends;
                } else {
                    const date = document.getElementById('eventDateSingle').value;
                    
                    if (!date) {
                        alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”');
                        return;
                    }
                    
                    eventData.date = date;
                }
                
                window.isSaving = true; // ì €ì¥ í”Œë˜ê·¸ ì„¤ì •
                
                if (window.editingEvent) {
                    // ìˆ˜ì •
                    const eventId = window.editingEvent.id;
                    window.customEvents[eventId] = eventData;
                    console.log('âœï¸ ì¼ì • ìˆ˜ì •:', eventId);
                } else {
                    // ì¶”ê°€
                    const eventId = 'custom_' + Date.now();
                    window.customEvents[eventId] = eventData;
                    console.log('â• ì¼ì • ì¶”ê°€:', eventId);
                }
                
                // Firebase ì €ì¥ (ê°ì²´ ì „ì²´ ì €ì¥)
                database.ref('calendar_data/customEvents').set(window.customEvents)
                    .then(() => {
                        console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ');
                        window.isSaving = false; // ì €ì¥ ì™„ë£Œ
                        window.closeModal();
                    })
                    .catch(error => {
                        console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
                        alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                        window.isSaving = false;
                    });
            };

            // ì¼ì • ì‚­ì œ
            window.deleteEvent = function() {
                if (!window.editingEvent) return;
                
                const eventId = window.editingEvent.id;
                
                // ì •ê¸° ì¼ì • ì‚­ì œ (ì´ë¯¸ editEventì—ì„œ ì²˜ë¦¬ë¨)
                if (eventId.startsWith('recurring_')) {
                    return;
                }
                
                // ì»¤ìŠ¤í…€ ì¼ì • ì‚­ì œ
                window.isSaving = true;
                
                delete window.customEvents[eventId];
                console.log('ğŸ—‘ï¸ ì¼ì • ì‚­ì œ:', eventId);
                
                // Firebase ì €ì¥ (ê°ì²´ ì „ì²´ ì €ì¥)
                database.ref('calendar_data/customEvents').set(window.customEvents)
                    .then(() => {
                        console.log('âœ… Firebase ì‚­ì œ ì™„ë£Œ');
                        window.isSaving = false;
                        window.closeModal();
                    })
                    .catch(error => {
                        console.error('âŒ Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
                        alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                        window.isSaving = false;
                    });
            };

            // ğŸ” ëª¨ë“  ì¼ì • ë³´ê¸° (Firebaseì— ì €ì¥ëœ ì¼ì • ì§ì ‘ ì‚­ì œ ê°€ëŠ¥)
            window.showAllEvents = function() {
                const allEventsList = document.getElementById('allEventsList');
                let html = '<div style="margin-bottom: 15px; padding: 10px; background: #fff9e6; border-radius: 5px; border-left: 3px solid #ffc107;">';
                html += '<strong>âš ï¸ ì£¼ì˜:</strong> ì—¬ê¸°ì„œ ì‚­ì œí•˜ë©´ Firebaseì—ì„œ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤!<br>';
                html += '<small style="color: #666;">ì¼ë°˜ ì‚­ì œëŠ” ìº˜ë¦°ë”ì—ì„œ ì¼ì •ì„ í´ë¦­í•˜ì„¸ìš”.</small>';
                html += '</div>';
                
                // ì •ê¸° ì¼ì •
                const recurringEvents = getRecurringEvents(
                    window.currentDate.getFullYear(),
                    window.currentDate.getMonth()
                );
                
                if (recurringEvents.length > 0) {
                    html += '<div style="margin-bottom: 15px;"><strong style="color: #4a9d6f;">ğŸ“Œ ì •ê¸° ì¼ì • (í˜„ì¬ ë‹¬)</strong><br>';
                    recurringEvents.forEach(event => {
                        html += `<div style="margin: 8px 0; padding: 8px; background: #f5f5f5; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${event.date} - ${event.title}</span>
                            <button class="modal-btn modal-btn-danger" style="padding: 4px 8px; font-size: 10px;" 
                                onclick="window.permanentDeleteEvent('${event.id}', true)">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                // ì»¤ìŠ¤í…€ ì¼ì • (ê°ì²´ ìˆœíšŒ)
                const customEventsArray = Object.entries(window.customEvents);
                if (customEventsArray.length > 0) {
                    html += '<div><strong style="color: #e74c3c;">âœï¸ ì»¤ìŠ¤í…€ ì¼ì • (Firebase ì €ì¥)</strong><br>';
                    customEventsArray.forEach(([id, event]) => {
                        const dateInfo = event.startDate && event.endDate 
                            ? `${event.startDate} ~ ${event.endDate}` 
                            : event.date;
                        html += `<div style="margin: 8px 0; padding: 8px; background: #f5f5f5; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                            <span>${dateInfo} - ${event.title}</span>
                            <button class="modal-btn modal-btn-danger" style="padding: 4px 8px; font-size: 10px;" 
                                onclick="window.permanentDeleteEvent('${id}', false)">ğŸ—‘ï¸ Firebase ì‚­ì œ</button>
                        </div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<div style="color: #999; text-align: center; padding: 20px;">ì €ì¥ëœ ì»¤ìŠ¤í…€ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                }
                
                allEventsList.innerHTML = html;
                document.getElementById('allEventsModal').classList.add('active');
            };

            // Firebaseì—ì„œ ì˜êµ¬ ì‚­ì œ
            window.permanentDeleteEvent = function(eventId, isRecurring) {
                const confirmMsg = isRecurring 
                    ? "ì •ê¸° ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì‚­ì œí•˜ë©´ ë‹¤ì‹œ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                    : "ì´ ì¼ì •ì„ Firebaseì—ì„œ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!";
                
                const confirmed = window.confirm(confirmMsg);
                
                if (confirmed) {
                    window.isSaving = true;
                    
                    if (isRecurring) {
                        // ì •ê¸° ì¼ì • ì‚­ì œ
                        window.deletedRecurringEvents.push(eventId);
                        database.ref('calendar_data/deletedRecurringEvents').set(window.deletedRecurringEvents)
                            .then(() => {
                                console.log('âœ… ì •ê¸° ì¼ì • ì‚­ì œ ì™„ë£Œ (Firebase)');
                                window.isSaving = false;
                                window.showAllEvents(); // ëª©ë¡ ê°±ì‹ 
                            })
                            .catch(error => {
                                console.error('âŒ Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
                                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                                window.isSaving = false;
                            });
                    } else {
                        // ì»¤ìŠ¤í…€ ì¼ì • ì‚­ì œ
                        delete window.customEvents[eventId];
                        database.ref('calendar_data/customEvents').set(window.customEvents)
                            .then(() => {
                                console.log('âœ… ì»¤ìŠ¤í…€ ì¼ì • ì‚­ì œ ì™„ë£Œ (Firebase)');
                                window.isSaving = false;
                                window.showAllEvents(); // ëª©ë¡ ê°±ì‹ 
                            })
                            .catch(error => {
                                console.error('âŒ Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
                                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                                window.isSaving = false;
                            });
                    }
                }
            };

            window.closeAllEventsModal = function() {
                document.getElementById('allEventsModal').classList.remove('active');
            };

            window.prevMonth = function() {
                window.currentDate.setMonth(window.currentDate.getMonth() - 1);
                window.renderCalendar();
            };

            window.nextMonth = function() {
                window.currentDate.setMonth(window.currentDate.getMonth() + 1);
                window.renderCalendar();
            };
            

            // ìº˜ë¦°ë” ë°ì´í„° ë¡œë“œ ì‹œì‘
            window.loadCustomEvents();
        }
    </script>
</body>
</html>
      